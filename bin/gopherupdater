#!/usr/bin/env sh

# Config
if [ "$1" = "sdf" ]; then
  GOPHER_DIR="/ftp/pub/users/tomasino/"
  SED_PARAM="s|\t\(/[^\t]*\)$|\t/users/tomasino\1|g"
  SED_CMD="/usr/pkg/bin/gsed"
else
  GOPHER_DIR="/home/tomasino/public_gopher"
  SED_PARAM="s|\t\(/[^\t]*\)$|\t/~tomasino\1|g"
  SED_CMD="sed"
fi

# move to working gopher directory
cd "${GOPHER_DIR}"

# grab the latest from the repo
git fetch origin master -q

# compare head sha vs local
remotesha="$(git rev-parse origin/master)"
localsha="$(git rev-parse HEAD)"

# if sha changed, run the updater
if [ "$remotesha" != "$localsha" ]; then
  # reset all local changes
  git reset --hard HEAD -q
  # pull in the latest changes
  git pull -q origin master
  # pull the moku-pona from master, if we can. It'll fall out of date between
  # phlog posts, but it's something for people to use in a pinch
  mkdir moku-pona 2> /dev/null
  curl -s gopher://gopher.black/1/moku-pona/ > moku-pona/gophermap 2> /dev/null
  # pull in reading lists too. They may also be slightly out of date
  mkdir reading 2> /dev/null
  curl -s gopher://gopher.black/0/reading/currentbooks.txt > reading/currentbooks.txt 2> /dev/null
  curl -s gopher://gopher.black/0/reading/recentbooks.txt > reading/recentbooks.txt 2> /dev/null
  # rename pathing for the local server
  find . -name "gophermap" -exec $SED_CMD -i"" "$SED_PARAM" {} \;
  # touch gopher dir itself (mostly for SDF phlog listing)
  touch .
fi
