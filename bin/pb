#!/bin/sh

version="v.2018.08.13"
flag_options="hv"
flag_version=0
flag_help=0
flag_file=0
data=""

show_help() {
   cat > /dev/stdout << END
pb [options] (data|filename)

Uploads a file to the tilde 0x0 paste bin

OPTIONAL FLAGS:
  -h          Show this help
  -v          Show current version number
END
}

die () {
  msg="$1"
  code="$2"
  # exit code defaults to 1
  if printf "%s" "${code}" | grep -q '^[0-9]+$'; then
    code=1
  fi
  # output message to stdout or stderr based on code
  if [ ! -z "${msg}" ]; then
    if [ "${code}" -eq 0 ]; then
      printf "%s\\n" "${msg}"
    else
      printf "%s\\n" "${msg}" >&2
    fi
  fi
  exit "${code}"
}

if [ -z "$@" ]; then
  flag_file=0
  data=$(cat < /dev/stdin )
else
  flag_file=1
  if ! parsed=$(getopt ${flag_options} "$@"); then
    die "Invalid input" 2
  fi
  eval set -- "${parsed}"
  while true; do
    case "$1" in
      -h)
        flag_help=1
        shift
        ;;
      -v)
        flag_version=1
        shift
        ;;
      --)
        shift
        break
        ;;
      *)
        die "Internal error: $1" 3
        ;;
    esac
  done
  data="$@"
fi

if [ ${flag_version} -gt 0 ]; then
  printf "%s\\n" "${version}"
  die "" 0
fi

if [ ${flag_help} -gt 0 ]; then
  show_help
  die "" 0
fi

if [ ${flag_file} -gt 0 ]; then
  if [ -z "${data}" ]; then
    printf "Provide a data to upload\\n"
  elif [ ! -f "${data}" ]; then
    printf "File not found.\\n"
  else
    curl -F"file=@${data}" https://0x0.tilde.team
  fi
else
  if [ -z "${data}" ]; then
    printf "No data found for upload. Please try again.\\n"
  else
    printf "${data}" | nc tilde.team 9999
  fi
fi

