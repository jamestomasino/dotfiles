#!/bin/sh

KEY_NAME=$1

if ! command -v lpass > /dev/null; then
  printf "LastPass CLI is required.\n"
  exit 2
fi

# Require something to be passed to this command
if [ -z "${KEY_NAME}" ]; then
  printf "You need to specify a key name.\n"
  exit 2
fi

# Try to find the passed key path / name
# TODO: move these paths to a list & loop
if [ -e "${KEY_NAME}" ]; then
  KEY_ID="${KEY_NAME}"
else
  if [ -e "${HOME}/.ssh/${KEY_NAME}" ]; then
    KEY_ID="${HOME}/.ssh/${KEY_NAME}"
  elif [ -e "${HOME}/.spideroak/Documents/Keys/personal/ssh/${KEY_NAME}/id_rsa" ]; then
    KEY_ID="${HOME}/.spideroak/Documents/Keys/personal/ssh/${KEY_NAME}/id_rsa"
  elif [ -e "${HOME}/.spideroak/Documents/Keys/work/ssh/${KEY_NAME}/id_rsa" ]; then
    KEY_ID="${HOME}/.spideroak/Documents/Keys/work/ssh/${KEY_NAME}/id_rsa"
  else
    printf "Could not find key file.\n"
    exit 1
  fi
fi

# If this key is already in the agent we don't need to do anything
if ( ssh-add -l | grep -q "${KEY_ID}" ); then
  printf "Key already present.\n"
  exit 0
fi

# Retrieve key from LastPass
PWD=$(lpass show --password "SSH: ${KEY_NAME}")

# In case LastPass exitted non-zero we have no password
if [ $? -eq 0 ]; then
# Fill password to ssh-add utility
expect <<EOF >/dev/null
spawn ssh-add ${KEY_ID}
expect "Enter passphrase"
send "$PWD\n"
expect eof
EOF
else
  printf "Unable to get password. Adding without password.\n"
  ssh-add "${KEY_ID}"
fi

# Check whether the key was added to the agent
if ( ssh-add -l | grep -q "${KEY_ID}" ); then
  printf "Key successfully added.\n"
  exit 0
else
  printf "Found passphrase but could not add key.\n"
  exit 1
fi
